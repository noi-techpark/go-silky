# Test: Pagination with nested steps (forEach inside paginated request)
# Demonstrates: combining pagination with nested operations, enriching paginated results

# Start with empty array
rootContext: []
stream: false

steps:
  - type: request
    name: Fetch Facilities
    request:
      url: https://www.onecenter.info/api/DAZ/GetFacilities
      method: GET
      headers:
        Accept: application/json
      body:

      # Pagination: fetch pages 0 and 1
      pagination:
        params:
          - name: offset
            location: query
            type: int
            default: 0
            increment: "+ 1"
        stopOn:
          - type: requestParam
            param: ".query.offset"
            compare: gt
            value: 1
    # Nested steps execute for EACH page's result
    # This allows enriching paginated data before merging
    steps:
      - type: forEach
        path: .
        as: facility
        steps:
          - type: request
            name: Get Facility Free Places
            request:
              # Nested request for each facility in the current page
              url: https://www.onecenter.info/api/DAZ/FacilityFreePlaces?FacilityID={{ .facility.FacilityId }}
              method: GET
              headers:
                Accept: application/json
            # Wrap result in array
            resultTransformer: '[.FreePlaces]'
            # Add FacilityDetails to each facility object
            mergeOn: .FacilityDetails = $res

    # Extract data array from each page after enrichment
    resultTransformer: .data
    